name: Deploy to Azure

on:
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      actions: read

    steps:
      - uses: actions/checkout@v4

      - name: Get Build Run ID
        id: get-run-id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find the latest successful run of 'Build and Test' for the current commit
          RUN_ID=$(gh run list --workflow "Build and Test" --commit ${{ github.sha }} --status success --limit 1 --json databaseId --jq '.[0].databaseId')
          
          if [ -z "$RUN_ID" ]; then
            echo "::error:: No successful 'Build and Test' run found for commit ${{ github.sha }}. Please ensure the build-test workflow has finished successfully for this commit."
            exit 1
          fi
          
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          run-id: ${{ steps.get-run-id.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./dist/toolbox/browser

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_C4BCCD6F32884502A82C471396DD32FB }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_B7A7AC6E73134FAC8A99674E317A2EC9 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_DCC79192346349369199FC0B8E04D96B }}

      - name: 'Deploy to Azure Web App'
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'bitspire-toolkit'
          slot-name: 'Production'
          package: ./dist/toolbox/browser

